parameters:
  cpack: true
  run_tests: true
  cmake_stepvars: ''
steps:
- task: CMake@1
  inputs:
    cmakeArgs: '--version'
- task: CMake@1
  inputs:
    cmakeArgs: '-DLSL_UNITTESTS=1 -DLSL_UNIXFOLDERS=1 ${{ parameters.cmake_stepvars }} $(cmakeargs) ..'
  displayName: 'Configure build'
- task: CMake@1
  inputs:
    cmakeArgs: '--build . -j --config Release --target install'
  displayName: 'Build files'
- ${{ if eq(parameters.cpack, 'true') }}:
  - bash: cpack
    workingDirectory: 'build'
    displayName: 'create cpack packages'
- ${{ if eq(parameters.run_tests, 'true') }}:
  - bash: build/install/bin/lsl_test_exported --gtest_shuffle --gtest_output=xml:test_exported_$(Agent.JobName).xml
    displayName: 'Run public API unit tests'
    timeoutInMinutes: 5
    continueOnError: true
#  - bash: build/testing/lsl_test_internal --gtest_shuffle --gtest_output=xml:test_internal_$(Agent.JobName).xml || true
#    displayName: 'Run internal unit tests'
#    timeoutInMinutes: 5
#    continueOnError: true
  - task: PublishTestResults@2
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: 'test_*.xml'
      failTaskOnFailedTests: false
- publish: $(System.DefaultWorkingDirectory)
  artifact: '$(Agent.JobName)_artifacts'
